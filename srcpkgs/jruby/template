# Template file for 'jruby'
pkgname=jruby
version=9.3.8.0
revision=1
hostmakedepends="apache-ant>=1.8 apache-maven>=3.3.0"
depends="virtual?java-runtime"
short_desc="Implementation of the Ruby language using the JVM"
maintainer="Chloris <chloris@freedommail.ch>"
license="EPL-2.0, GPL-2.0-only, LGPL-2.1-only"
homepage="https://www.jruby.org/"
distfiles="https://repo1.maven.org/maven2/org/jruby/jruby-dist/${version}/${pkgname}-dist-${version}-src.zip"
checksum=c2ee3b79c29afd86c538e347ba48d935703d0d1ee665010f9ae52adc358429e5
conflicts="ruby ruby-ri"

do_build() {
	./mvnw
}

post_build() {
	cd bin
	# Remove Windows scripts, binaries and libraries
	rm -f *.bat *.exe *.dll
}

do_install() {
	for file in bin/*
	do
		# Copy symlinks
		if [ -L "$file" ]
		then
			vcopy "$file" usr/bin
		# Install binaries with correct permissions
		elif [ -f "$file" ]
		then
			vbin "$file"
		fi
	done

	vmkdir usr/lib
	vinstall lib/jruby.jar 644 usr/lib/
	vcopy lib/ruby usr/lib/

	vdoc README.md

	# Fix file permissions on musl architectures
	if [ $XBPS_LIBC == 'musl' ]
	then
		find "$DESTDIR/usr/lib" -perm /022 -exec chmod go-w {} \;
	fi
}
